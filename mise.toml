[tools]
go = "1.25.3"
zig = "0.15.2"
"vfox:clang" = "19.1.7"
protoc = "27.2"
bun = "1.3.6"

[tasks.shim]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty}"
sources = [
  "go-ghostty/shim/build.zig",
  "go-ghostty/shim/build.zig.zon",
  "go-ghostty/shim/oniguruma_stub.zig",
  "go-ghostty/shim/vtr_ghostty_vt.h",
  "go-ghostty/shim/vtr_ghostty_vt_shim.zig",
  "go-ghostty/ghostty/**",
]
outputs = [
  "go-ghostty/shim/zig-out/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h",
]

[tasks.shim-sanitize]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty} -Doptimize=Debug -Dframe_pointers=true && mkdir -p zig-out && touch zig-out/.shim-sanitize.stamp"
sources = [
  "go-ghostty/shim/build.zig",
  "go-ghostty/shim/build.zig.zon",
  "go-ghostty/shim/oniguruma_stub.zig",
  "go-ghostty/shim/vtr_ghostty_vt.h",
  "go-ghostty/shim/vtr_ghostty_vt_shim.zig",
  "go-ghostty/ghostty/**",
]
outputs = ["go-ghostty/shim/zig-out/.shim-sanitize.stamp"]

[tasks.shim-llvm-ir]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty} -Doptimize=Debug -Dframe_pointers=true -Demit_llvm_ir=true"
sources = [
  "go-ghostty/shim/build.zig",
  "go-ghostty/shim/build.zig.zon",
  "go-ghostty/shim/oniguruma_stub.zig",
  "go-ghostty/shim/vtr_ghostty_vt.h",
  "go-ghostty/shim/vtr_ghostty_vt_shim.zig",
  "go-ghostty/ghostty/**",
]
outputs = ["go-ghostty/shim/zig-out/llvm-ir/vtr-ghostty-vt.ll"]

[tasks.shim-llvm-asan]
depends = ["shim-llvm-ir"]
run = "mkdir -p go-ghostty/shim/zig-out-asan/lib go-ghostty/shim/zig-out-asan/include && clang -x ir -c -fsanitize=address -fno-omit-frame-pointer -fPIC -o go-ghostty/shim/zig-out-asan/lib/vtr-ghostty-vt-asan.o go-ghostty/shim/zig-out/llvm-ir/vtr-ghostty-vt.ll && ZIG_LIB_DIR=$(zig env | awk '/lib_dir/ {print $3}' | tr -d '\",') && zig build-obj -OReleaseFast -femit-bin=go-ghostty/shim/zig-out-asan/lib/stack_probe.o \"$ZIG_LIB_DIR/compiler_rt/stack_probe.zig\" && ar rcs go-ghostty/shim/zig-out-asan/lib/libvtr-ghostty-vt.a go-ghostty/shim/zig-out-asan/lib/vtr-ghostty-vt-asan.o go-ghostty/shim/zig-out-asan/lib/stack_probe.o && cp go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h go-ghostty/shim/zig-out-asan/include/"
sources = [
  "go-ghostty/shim/zig-out/llvm-ir/vtr-ghostty-vt.ll",
  "go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h",
]
outputs = [
  "go-ghostty/shim/zig-out-asan/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out-asan/include/vtr_ghostty_vt.h",
]

[tasks.proto]
run = "protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/vtr.proto"
sources = ["proto/vtr.proto"]
outputs = ["proto/vtr.pb.go", "proto/vtr_grpc.pb.go"]

[tasks.web-build]
run = "cd web && bun install && bun run build"
sources = [
  "web/index.html",
  "web/package.json",
  "web/bun.lock",
  "web/postcss.config.js",
  "web/tailwind.config.ts",
  "web/tsconfig.json",
  "web/tsconfig.node.json",
  "web/vite.config.ts",
  "web/public/**",
  "web/scripts/**",
  "web/src/**",
]
outputs = ["web/dist/index.html"]

[tasks.build]
depends = ["proto", "shim", "web-build"]
run = "sh -c 'set -euo pipefail; VERSION=$(git describe --tags --exact-match --match \"v*\" 2>/dev/null | sed \"s/^v//\" || cat VERSION); go build -o bin/vtr -ldflags \"-X main.Version=${VERSION}\" ./cmd/vtr'"
env = { CGO_ENABLED = "1", CC = "clang", CXX = "clang++" }
sources = [
  "VERSION",
  "go.mod",
  "go.sum",
  "cmd/**/*.go",
  "server/**/*.go",
  "web/**/*.go",
  "go-ghostty/**/*.go",
  "proto/*.go",
  "go-ghostty/shim/zig-out/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h",
]
outputs = ["bin/vtr"]

[tasks.test]
depends = ["proto", "shim"]
run = "go test ./... && mkdir -p bin && touch bin/.mise-test.stamp"
env = { CGO_ENABLED = "1", CC = "clang", CXX = "clang++" }
sources = [
  "go.mod",
  "go.sum",
  "cmd/**/*.go",
  "server/**/*.go",
  "web/**/*.go",
  "go-ghostty/**/*.go",
  "proto/*.go",
  "go-ghostty/shim/zig-out/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h",
]
outputs = ["bin/.mise-test.stamp"]

[tasks.test-race-cgo]
depends = ["proto", "shim"]
run = "CGO_ENABLED=1 CC=clang CXX=clang++ go test -race ./go-ghostty/... ./server/... && mkdir -p bin && touch bin/.mise-test-race-cgo.stamp"
sources = [
  "go.mod",
  "go.sum",
  "server/**/*.go",
  "go-ghostty/**/*.go",
  "proto/*.go",
  "go-ghostty/shim/zig-out/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h",
]
outputs = ["bin/.mise-test-race-cgo.stamp"]

[tasks.test-sanitize-cgo]
depends = ["proto", "shim-llvm-asan"]
run = "GOEXPERIMENT=${GOEXPERIMENT:-cgocheck2} ASAN_OPTIONS=detect_leaks=1:halt_on_error=1:suppressions=$PWD/go-ghostty/shim/sanitizers/asan.supp LSAN_OPTIONS=suppressions=$PWD/go-ghostty/shim/sanitizers/lsan.supp CGO_ENABLED=1 CC=clang CXX=clang++ go test -asan -tags=asan ./go-ghostty/... ./server/... && mkdir -p bin && touch bin/.mise-test-sanitize-cgo.stamp"
sources = [
  "go.mod",
  "go.sum",
  "server/**/*.go",
  "go-ghostty/**/*.go",
  "proto/*.go",
  "go-ghostty/shim/zig-out-asan/lib/libvtr-ghostty-vt.a",
  "go-ghostty/shim/zig-out-asan/include/vtr_ghostty_vt.h",
]
outputs = ["bin/.mise-test-sanitize-cgo.stamp"]

[tasks.test-web-e2e]
depends = ["proto", "shim", "web-build"]
run = "cd web && bun install && bunx playwright install chromium && bun run test:e2e && mkdir -p ../bin && touch ../bin/.mise-test-web-e2e.stamp"
sources = [
  "go.mod",
  "go.sum",
  "cmd/**/*.go",
  "server/**/*.go",
  "proto/*.go",
  "web/package.json",
  "web/bun.lock",
  "web/playwright.config.ts",
  "web/public/**",
  "web/scripts/**",
  "web/tests/**/*.ts",
  "web/src/**",
]
outputs = ["bin/.mise-test-web-e2e.stamp"]

[tasks."web-vite:dev"]
depends = ["proto"]
run = "bun run dev"
dir = "./web"

[tasks."web:dev"]
depends = ["proto"]
run = "sh -c 'mkdir -p .logs && go run ./cmd/vtr web --dev --socket /tmp/vtr.sock 2>&1 | tee .logs/vtr-web.log'"
env = { VTR_LOG_RESIZE = "1" }

[tasks."serve:dev"]
depends = ["proto"]
run = "sh -c 'mkdir -p .logs && go run ./cmd/vtr serve --socket /tmp/vtr.sock 2>&1 | tee .logs/vtr-serve.log'"
env = { VTR_LOG_RESIZE = "1" }

[tasks.dev]
depends = [
  "web-vite:dev",
  "web:dev",
  "serve:dev"
]

[tasks.all]
depends = ["build", "test"]

[tasks.clean]
run = "rm -rf bin/ && rm -f proto/*.pb.go"
