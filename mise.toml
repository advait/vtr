[tools]
go = "1.25.3"
zig = "0.15.2"
"vfox:clang" = "19.1.7"

[tasks.shim]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty}"

[tasks.shim-sanitize]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty} -Doptimize=Debug -Dframe_pointers=true"

[tasks.shim-llvm-ir]
run = "cd go-ghostty/shim && zig build -Dghostty=${GHOSTTY_ROOT:-../ghostty} -Doptimize=Debug -Dframe_pointers=true -Demit_llvm_ir=true"

[tasks.shim-llvm-asan]
depends = ["shim-llvm-ir"]
run = "mkdir -p go-ghostty/shim/zig-out-asan/lib go-ghostty/shim/zig-out-asan/include && clang -x ir -c -fsanitize=address -fno-omit-frame-pointer -fPIC -o go-ghostty/shim/zig-out-asan/lib/vtr-ghostty-vt-asan.o go-ghostty/shim/zig-out/llvm-ir/vtr-ghostty-vt.ll && ar rcs go-ghostty/shim/zig-out-asan/lib/libvtr-ghostty-vt.a go-ghostty/shim/zig-out-asan/lib/vtr-ghostty-vt-asan.o && cp go-ghostty/shim/zig-out/include/vtr_ghostty_vt.h go-ghostty/shim/zig-out-asan/include/"

[tasks.proto]
run = "protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/vtr.proto"

[tasks.build]
depends = ["shim"]
run = "go build -o bin/vtr ./cmd/vtr"
env = { CGO_ENABLED = "1", CC = "clang", CXX = "clang++" }

[tasks.test]
depends = ["shim"]
run = "go test ./..."
env = { CGO_ENABLED = "1", CC = "clang", CXX = "clang++" }

[tasks.test-race-cgo]
depends = ["shim"]
run = "CGO_ENABLED=1 CC=clang CXX=clang++ go test -race ./go-ghostty/... ./server/..."

[tasks.test-sanitize-cgo]
depends = ["shim-llvm-asan"]
run = "GODEBUG=cgocheck=2 GOEXPERIMENT=${GOEXPERIMENT:-cgocheck2} ASAN_OPTIONS=detect_leaks=1:halt_on_error=1:suppressions=go-ghostty/shim/sanitizers/asan.supp LSAN_OPTIONS=suppressions=go-ghostty/shim/sanitizers/lsan.supp CGO_ENABLED=1 CC=clang CXX=clang++ go test -asan -tags=asan ./go-ghostty/... ./server/..."

[tasks.all]
depends = ["build", "test"]

[tasks.clean]
run = "rm -rf bin/ && rm -f proto/*.pb.go"
